<!doctype html>
<html>
  <head>
  	<title>semantic-diff</title>
    <style type="text/css">
    body {
        margin: 0;
        padding: 0;
    }
    .insert {
        background-color: #eaffea;
        outline: 1px solid #c1e9c1;
    }
    .delete {
        background-color: #ffecec;
        outline: 1px solid #f1c0c0;
    }
    .replace {
        background-color: #eee;
    }
    </style>
    <script type="text/javascript">
    function loadJSON(path, callback) {
        var request = new XMLHttpRequest();
        request.overrideMimeType("application/json");
        request.open('GET', '' + path, true);
        request.onreadystatechange = function () {
            if (request.readyState == 4 && (request.status == "200" || request.status == 0)) {
                callback(JSON.parse(request.responseText));
            }
        };
        request.send(null);
    }

    function wrap(tagName, element) {
        if (element == null) { return null; }
        var node = document.createElement(tagName);
        node.appendChild(element);
        return node;
    }

    function Delete(before, a, b) {
        this.before = new Term(before, a);
        return this;
    }

    function Insert(after, a, b) {
        this.after = new Term(after, b);
        return this;
    }

    function Replace(before, after, a, b) {
        this.before = new Term(before, a);
        this.after = new Term(after, b);
        return this;
    }

    function Term(json, source) {
        this.source = source;
        this.range = json.extract;
        this.syntax = syntax(json.unwrap, function(x) { return new Term(x, source); });
        this.syntax.source = source;
        this.syntax.range = this.range;
        return this;
    }

    function toDOM(model) {
        var element;

        if (model instanceof Delete) {
            element = document.createElement("div");
            element.classList.add("delete");
            element.appendChild(toDOM(model.before));
        }

        if (model instanceof Insert) {
            element = document.createElement("div");
            element.classList.add("insert");
            element.appendChild(toDOM(model.after));
        }

        if (model instanceof Replace) {
            element = document.createElement("div");
            element.classList.add("replace");
            var before = toDOM(model.before);
            before.classList.add("delete");
            element.appendChild(before);
            var after = toDOM(model.after);
            after.classList.add("insert");
            element.appendChild(after);
        }

        if (model instanceof Term) {
            element = document.createElement("div");
            element.classList.add("term");
            element.appendChild(toDOM(model.syntax));
        }

        if (model instanceof Diff) {
            element = document.createElement("div");
            element.classList.add("diff");
            if (model.pure != null) {
                element.classList.add("pure");
                element.appendChild(toDOM(model.pure));
            } else if(model.roll != null) {
                element.classList.add("roll");
                element.appendChild(toDOM(model.roll));
            }
        }

        if (model instanceof Indexed) {
            element = document.createElement("ul");
            for (i in model.values) {
                element.appendChild(wrap("li", toDOM(model.values[i])));
            }
        }

        if (model instanceof Keyed) {
            element = document.createElement("dl");
            for (k in model.values) {
                var dt = document.createElement("dt");
                dt.textContent = k;
                element.appendChild(dt);
                element.appendChild(wrap("dd", toDOM(model.values[k])));
            }
        }

        if (model instanceof Leaf) {
            element = document.createElement("span");
            if (model.source != null && model.range != null) {
                element.textContent = model.source.substr(model.range[0], model.range[1]);
            }
            // ?
        }

        return element;
    }

    function patch(patch, a, b) {
        if (patch.delete != null) { return new Delete(patch.delete, a, b); }
        if (patch.insert != null) { return new Insert(patch.insert, a, b); }
        if (patch.replace != null) { return new Replace(patch.replace.before, patch.replace.after, a, b); }
    }

    function Indexed(array, continuation) {
        this.values = [];
        for (index in array) {
            this.values.push(continuation(array[index]));
        }
        return this;
    }

    function Keyed(object, continuation) {
        this.values = {};
        for (key in object) {
            this.values[key] = continuation(object[key]);
        }
        return this;
    }

    function Leaf(object) {
        this.value = object;
        return this;
    }

    function syntax(json, continuation) {
        if (json instanceof Array) { return new Indexed(json, continuation); }
        if (json instanceof Object) { return new Keyed(json, continuation); }
        return new Leaf(json);
    }

    function Diff(json, a, b) {
        if (json.pure != null) { this.pure = patch(json.pure, a, b); }
        if (json.roll != null) { this.roll = syntax(json.roll, function(x) { return new Diff(x, a, b); }); }
        return this;
    }
    </script>
  </head>
  <body>
    <div id="diff"></div>
    <script type="text/javascript">
    loadJSON('diff.json', function (json) {
        var model = new Diff(json.diff, json.a, json.b);
        var dom = toDOM(model);
        var root = document.getElementById("diff");
        root.appendChild(dom);
    });
    </script>
  </body>
</html>
